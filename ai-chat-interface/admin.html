<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface - 관리자 대시보드</title>
    <link rel="stylesheet" href="admin.css">
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="admin-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 토큰 관리
        const getAuthToken = () => localStorage.getItem('admin_token');
        const setAuthToken = (token) => localStorage.setItem('admin_token', token);
        const removeAuthToken = () => localStorage.removeItem('admin_token');

        // API 요청 헤더 설정
        const getAuthHeaders = () => {
            const token = getAuthToken();
            return token ? { Authorization: `Bearer ${token}` } : {};
        };

        // 로그인 컴포넌트
        function LoginForm({ onLogin }) {
            const [credentials, setCredentials] = useState({ username: '', password: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const response = await axios.post('/api/admin/login', credentials);
                    if (response.data.success) {
                        setAuthToken(response.data.token);
                        onLogin(response.data);
                    }
                } catch (error) {
                    setError(error.response?.data?.error || '로그인 실패');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-form">
                        <h1>🔐 관리자 로그인</h1>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>사용자명</label>
                                <input
                                    type="text"
                                    value={credentials.username}
                                    onChange={(e) => setCredentials({...credentials, username: e.target.value})}
                                    placeholder="관리자 사용자명"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>패스워드</label>
                                <input
                                    type="password"
                                    value={credentials.password}
                                    onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                    placeholder="패스워드"
                                    required
                                />
                            </div>
                            <button type="submit" disabled={loading} className="login-btn">
                                {loading ? '로그인 중...' : '로그인'}
                            </button>
                        </form>
                        <div className="login-info">
                            <p>기본 계정: admin / admin123</p>
                        </div>
                    </div>
                </div>
            );
        }

        // 시스템 상태 컴포넌트
        function SystemStatus() {
            const [systemInfo, setSystemInfo] = useState(null);
            const [healthInfo, setHealthInfo] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchSystemInfo = async () => {
                    try {
                        const [statusResponse, healthResponse] = await Promise.all([
                            axios.get('/api/admin/system/status', { headers: getAuthHeaders() }),
                            axios.get('/api/admin/system/health', { headers: getAuthHeaders() })
                        ]);

                        setSystemInfo(statusResponse.data.system);
                        setHealthInfo(healthResponse.data);
                    } catch (error) {
                        console.error('시스템 정보 조회 실패:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchSystemInfo();
                const interval = setInterval(fetchSystemInfo, 30000); // 30초마다 업데이트

                return () => clearInterval(interval);
            }, []);

            if (loading) return <div className="loading">시스템 상태 조회 중...</div>;

            return (
                <div className="system-status">
                    <h2>📊 시스템 상태</h2>

                    {/* 헬스 체크 */}
                    <div className="health-overview">
                        <div className={`health-indicator ${healthInfo?.overall_health}`}>
                            <span className="health-status">
                                {healthInfo?.overall_health === 'healthy' ? '🟢 정상' : '🟡 주의'}
                            </span>
                            <span className="health-text">전체 시스템 상태</span>
                        </div>
                    </div>

                    {/* 서비스 상태 */}
                    <div className="services-grid">
                        {healthInfo?.services && Object.entries(healthInfo.services).map(([service, status]) => (
                            <div key={service} className={`service-card ${status}`}>
                                <div className="service-name">{service}</div>
                                <div className="service-status">
                                    {status === 'healthy' ? '🟢' : status === 'error' ? '🔴' : '🟡'} {status}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* 시스템 리소스 */}
                    {systemInfo && (
                        <div className="resource-grid">
                            <div className="resource-card">
                                <h3>CPU 사용률</h3>
                                <div className="metric-value">{systemInfo.cpu_usage.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.cpu_usage}%`}}></div>
                                </div>
                            </div>

                            <div className="resource-card">
                                <h3>메모리 사용률</h3>
                                <div className="metric-value">{systemInfo.memory.percent.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.memory.percent}%`}}></div>
                                </div>
                                <div className="metric-details">
                                    {(systemInfo.memory.used / 1024 / 1024 / 1024).toFixed(1)}GB /
                                    {(systemInfo.memory.total / 1024 / 1024 / 1024).toFixed(1)}GB
                                </div>
                            </div>

                            <div className="resource-card">
                                <h3>디스크 사용률</h3>
                                <div className="metric-value">{systemInfo.disk.percent.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.disk.percent}%`}}></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 프로젝트 관리 컴포넌트
        function ProjectManagement() {
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchProjects = async () => {
                    try {
                        const response = await axios.get('/api/admin/projects', { headers: getAuthHeaders() });
                        setProjects(response.data.projects || []);
                    } catch (error) {
                        console.error('프로젝트 조회 실패:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchProjects();
            }, []);

            const handleForceComplete = async (projectId) => {
                if (!confirm('이 프로젝트를 강제로 완료 처리하시겠습니까?')) return;

                try {
                    await axios.put(`/api/admin/projects/${projectId}/force-complete`, {}, { headers: getAuthHeaders() });
                    alert('프로젝트가 완료 처리되었습니다');
                    // 프로젝트 목록 새로고침
                    window.location.reload();
                } catch (error) {
                    alert('프로젝트 완료 처리 실패: ' + (error.response?.data?.error || '알 수 없는 오류'));
                }
            };

            if (loading) return <div className="loading">프로젝트 정보 조회 중...</div>;

            return (
                <div className="project-management">
                    <h2>📁 프로젝트 관리</h2>

                    <div className="projects-overview">
                        <div className="stat-card">
                            <div className="stat-number">{projects.length}</div>
                            <div className="stat-label">전체 프로젝트</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">
                                {projects.filter(p => p.status === 'completed').length}
                            </div>
                            <div className="stat-label">완료 프로젝트</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">
                                {projects.filter(p => p.status === 'in_progress').length}
                            </div>
                            <div className="stat-label">진행 중</div>
                        </div>
                    </div>

                    <div className="projects-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>프로젝트명</th>
                                    <th>AI 프레임워크</th>
                                    <th>상태</th>
                                    <th>진행률</th>
                                    <th>생성일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {projects.map(project => (
                                    <tr key={project.id}>
                                        <td>{project.name}</td>
                                        <td>
                                            <span className={`framework-badge ${project.selected_ai}`}>
                                                {project.selected_ai === 'crew-ai' ? 'CrewAI' : 'MetaGPT'}
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`status-badge ${project.status}`}>
                                                {project.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div className="progress-bar">
                                                <div className="progress-fill"
                                                     style={{width: `${project.progress_percentage || 0}%`}}>
                                                </div>
                                            </div>
                                            {project.progress_percentage || 0}%
                                        </td>
                                        <td>{new Date(project.created_at).toLocaleDateString()}</td>
                                        <td>
                                            {project.status !== 'completed' && (
                                                <button
                                                    className="action-btn complete"
                                                    onClick={() => handleForceComplete(project.id)}
                                                >
                                                    완료 처리
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // LLM 모델 관리 컴포넌트
        function LLMManagement() {
            const [models, setModels] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchModels = async () => {
                    try {
                        const response = await axios.get('/api/admin/llm-models', { headers: getAuthHeaders() });
                        setModels(response.data.models || []);
                    } catch (error) {
                        console.error('LLM 모델 조회 실패:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchModels();
            }, []);

            if (loading) return <div className="loading">LLM 모델 정보 조회 중...</div>;

            return (
                <div className="llm-management">
                    <h2>🤖 LLM 모델 관리</h2>

                    <div className="models-grid">
                        {models.map(model => (
                            <div key={model.id} className={`model-card ${model.status}`}>
                                <div className="model-header">
                                    <h3>{model.name}</h3>
                                    <span className={`status-indicator ${model.status}`}>
                                        {model.status === 'active' ? '🟢' : '🔴'}
                                    </span>
                                </div>
                                <div className="model-info">
                                    <div className="model-provider">제공: {model.provider}</div>
                                    <div className="model-usage">사용 횟수: {model.usage_count}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // 메인 관리자 대시보드 컴포넌트
        function AdminDashboard({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('system');

            const tabs = [
                { id: 'system', name: '시스템 상태', icon: '📊' },
                { id: 'projects', name: '프로젝트 관리', icon: '📁' },
                { id: 'llm', name: 'LLM 관리', icon: '🤖' },
                { id: 'settings', name: '설정', icon: '⚙️' }
            ];

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'system':
                        return <SystemStatus />;
                    case 'projects':
                        return <ProjectManagement />;
                    case 'llm':
                        return <LLMManagement />;
                    case 'settings':
                        return <div className="settings">⚙️ 설정 기능 개발 중...</div>;
                    default:
                        return <SystemStatus />;
                }
            };

            return (
                <div className="admin-dashboard">
                    <header className="admin-header">
                        <div className="header-left">
                            <h1>🛡️ AI Chat Interface 관리자</h1>
                            <span className="user-info">관리자: {user.username}</span>
                        </div>
                        <div className="header-right">
                            <button className="logout-btn" onClick={onLogout}>
                                로그아웃
                            </button>
                        </div>
                    </header>

                    <div className="admin-layout">
                        <nav className="admin-sidebar">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    className={`nav-tab ${activeTab === tab.id ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab.id)}
                                >
                                    <span className="tab-icon">{tab.icon}</span>
                                    <span className="tab-name">{tab.name}</span>
                                </button>
                            ))}
                        </nav>

                        <main className="admin-content">
                            {renderTabContent()}
                        </main>
                    </div>
                </div>
            );
        }

        // 메인 앱 컴포넌트
        function AdminApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // 토큰 검증
                const verifyToken = async () => {
                    const token = getAuthToken();
                    if (!token) {
                        setLoading(false);
                        return;
                    }

                    try {
                        const response = await axios.get('/api/admin/verify', { headers: getAuthHeaders() });
                        if (response.data.success) {
                            setUser(response.data.admin);
                        }
                    } catch (error) {
                        removeAuthToken();
                    } finally {
                        setLoading(false);
                    }
                };

                verifyToken();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                removeAuthToken();
                setUser(null);
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading">관리자 시스템 로드 중...</div>
                    </div>
                );
            }

            return user ?
                <AdminDashboard user={user} onLogout={handleLogout} /> :
                <LoginForm onLogin={handleLogin} />;
        }

        // 렌더링
        ReactDOM.render(<AdminApp />, document.getElementById('admin-root'));
    </script>
</body>
</html>