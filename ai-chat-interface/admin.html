<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="admin.css">
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="admin-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // í† í° ê´€ë¦¬
        const getAuthToken = () => localStorage.getItem('admin_token');
        const setAuthToken = (token) => localStorage.setItem('admin_token', token);
        const removeAuthToken = () => localStorage.removeItem('admin_token');

        // API ìš”ì²­ í—¤ë” ì„¤ì •
        const getAuthHeaders = () => {
            const token = getAuthToken();
            return token ? { Authorization: `Bearer ${token}` } : {};
        };

        // ë¡œê·¸ì¸ ì»´í¬ë„ŒíŠ¸
        function LoginForm({ onLogin }) {
            const [credentials, setCredentials] = useState({ username: '', password: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const response = await axios.post('/api/admin/login', credentials);
                    if (response.data.success) {
                        setAuthToken(response.data.token);
                        onLogin(response.data);
                    }
                } catch (error) {
                    setError(error.response?.data?.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-form">
                        <h1>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>ì‚¬ìš©ìëª…</label>
                                <input
                                    type="text"
                                    value={credentials.username}
                                    onChange={(e) => setCredentials({...credentials, username: e.target.value})}
                                    placeholder="ê´€ë¦¬ì ì‚¬ìš©ìëª…"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>íŒ¨ìŠ¤ì›Œë“œ</label>
                                <input
                                    type="password"
                                    value={credentials.password}
                                    onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                    placeholder="íŒ¨ìŠ¤ì›Œë“œ"
                                    required
                                />
                            </div>
                            <button type="submit" disabled={loading} className="login-btn">
                                {loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
                            </button>
                        </form>
                        <div className="login-info">
                            <p>ê¸°ë³¸ ê³„ì •: admin / admin123</p>
                        </div>
                    </div>
                </div>
            );
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ ì»´í¬ë„ŒíŠ¸
        function SystemStatus() {
            const [systemInfo, setSystemInfo] = useState(null);
            const [healthInfo, setHealthInfo] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchSystemInfo = async () => {
                    try {
                        const [statusResponse, healthResponse] = await Promise.all([
                            axios.get('/api/admin/system/status', { headers: getAuthHeaders() }),
                            axios.get('/api/admin/system/health', { headers: getAuthHeaders() })
                        ]);

                        setSystemInfo(statusResponse.data.system);
                        setHealthInfo(healthResponse.data);
                    } catch (error) {
                        console.error('ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchSystemInfo();
                const interval = setInterval(fetchSystemInfo, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸

                return () => clearInterval(interval);
            }, []);

            if (loading) return <div className="loading">ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ ì¤‘...</div>;

            return (
                <div className="system-status">
                    <h2>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h2>

                    {/* í—¬ìŠ¤ ì²´í¬ */}
                    <div className="health-overview">
                        <div className={`health-indicator ${healthInfo?.overall_health}`}>
                            <span className="health-status">
                                {healthInfo?.overall_health === 'healthy' ? 'ğŸŸ¢ ì •ìƒ' : 'ğŸŸ¡ ì£¼ì˜'}
                            </span>
                            <span className="health-text">ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ</span>
                        </div>
                    </div>

                    {/* ì„œë¹„ìŠ¤ ìƒíƒœ */}
                    <div className="services-grid">
                        {healthInfo?.services && Object.entries(healthInfo.services).map(([service, status]) => (
                            <div key={service} className={`service-card ${status}`}>
                                <div className="service-name">{service}</div>
                                <div className="service-status">
                                    {status === 'healthy' ? 'ğŸŸ¢' : status === 'error' ? 'ğŸ”´' : 'ğŸŸ¡'} {status}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ */}
                    {systemInfo && (
                        <div className="resource-grid">
                            <div className="resource-card">
                                <h3>CPU ì‚¬ìš©ë¥ </h3>
                                <div className="metric-value">{systemInfo.cpu_usage.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.cpu_usage}%`}}></div>
                                </div>
                            </div>

                            <div className="resource-card">
                                <h3>ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </h3>
                                <div className="metric-value">{systemInfo.memory.percent.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.memory.percent}%`}}></div>
                                </div>
                                <div className="metric-details">
                                    {(systemInfo.memory.used / 1024 / 1024 / 1024).toFixed(1)}GB /
                                    {(systemInfo.memory.total / 1024 / 1024 / 1024).toFixed(1)}GB
                                </div>
                            </div>

                            <div className="resource-card">
                                <h3>ë””ìŠ¤í¬ ì‚¬ìš©ë¥ </h3>
                                <div className="metric-value">{systemInfo.disk.percent.toFixed(1)}%</div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${systemInfo.disk.percent}%`}}></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // í”„ë¡œì íŠ¸ ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸
        function ProjectManagement() {
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchProjects = async () => {
                    try {
                        const response = await axios.get('/api/admin/projects', { headers: getAuthHeaders() });
                        setProjects(response.data.projects || []);
                    } catch (error) {
                        console.error('í”„ë¡œì íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchProjects();
            }, []);

            const handleForceComplete = async (projectId) => {
                if (!confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ ê°•ì œë¡œ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                try {
                    await axios.put(`/api/admin/projects/${projectId}/force-complete`, {}, { headers: getAuthHeaders() });
                    alert('í”„ë¡œì íŠ¸ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    // í”„ë¡œì íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    window.location.reload();
                } catch (error) {
                    alert('í”„ë¡œì íŠ¸ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (error.response?.data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            };

            if (loading) return <div className="loading">í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ ì¤‘...</div>;

            return (
                <div className="project-management">
                    <h2>ğŸ“ í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>

                    <div className="projects-overview">
                        <div className="stat-card">
                            <div className="stat-number">{projects.length}</div>
                            <div className="stat-label">ì „ì²´ í”„ë¡œì íŠ¸</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">
                                {projects.filter(p => p.status === 'completed').length}
                            </div>
                            <div className="stat-label">ì™„ë£Œ í”„ë¡œì íŠ¸</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">
                                {projects.filter(p => p.status === 'in_progress').length}
                            </div>
                            <div className="stat-label">ì§„í–‰ ì¤‘</div>
                        </div>
                    </div>

                    <div className="projects-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>í”„ë¡œì íŠ¸ëª…</th>
                                    <th>AI í”„ë ˆì„ì›Œí¬</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì§„í–‰ë¥ </th>
                                    <th>ìƒì„±ì¼</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {projects.map(project => (
                                    <tr key={project.id}>
                                        <td>{project.name}</td>
                                        <td>
                                            <span className={`framework-badge ${project.selected_ai}`}>
                                                {project.selected_ai === 'crew-ai' ? 'CrewAI' : 'MetaGPT'}
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`status-badge ${project.status}`}>
                                                {project.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div className="progress-bar">
                                                <div className="progress-fill"
                                                     style={{width: `${project.progress_percentage || 0}%`}}>
                                                </div>
                                            </div>
                                            {project.progress_percentage || 0}%
                                        </td>
                                        <td>{new Date(project.created_at).toLocaleDateString()}</td>
                                        <td>
                                            {project.status !== 'completed' && (
                                                <button
                                                    className="action-btn complete"
                                                    onClick={() => handleForceComplete(project.id)}
                                                >
                                                    ì™„ë£Œ ì²˜ë¦¬
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // LLM ëª¨ë¸ ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸
        function LLMManagement() {
            const [models, setModels] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchModels = async () => {
                    try {
                        const response = await axios.get('/api/admin/llm-models', { headers: getAuthHeaders() });
                        setModels(response.data.models || []);
                    } catch (error) {
                        console.error('LLM ëª¨ë¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchModels();
            }, []);

            if (loading) return <div className="loading">LLM ëª¨ë¸ ì •ë³´ ì¡°íšŒ ì¤‘...</div>;

            return (
                <div className="llm-management">
                    <h2>ğŸ¤– LLM ëª¨ë¸ ê´€ë¦¬</h2>

                    <div className="models-grid">
                        {models.map(model => (
                            <div key={model.id} className={`model-card ${model.status}`}>
                                <div className="model-header">
                                    <h3>{model.name}</h3>
                                    <span className={`status-indicator ${model.status}`}>
                                        {model.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'}
                                    </span>
                                </div>
                                <div className="model-info">
                                    <div className="model-provider">ì œê³µ: {model.provider}</div>
                                    <div className="model-usage">ì‚¬ìš© íšŸìˆ˜: {model.usage_count}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ë©”ì¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸
        function AdminDashboard({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('system');

            const tabs = [
                { id: 'system', name: 'ì‹œìŠ¤í…œ ìƒíƒœ', icon: 'ğŸ“Š' },
                { id: 'projects', name: 'í”„ë¡œì íŠ¸ ê´€ë¦¬', icon: 'ğŸ“' },
                { id: 'llm', name: 'LLM ê´€ë¦¬', icon: 'ğŸ¤–' },
                { id: 'settings', name: 'ì„¤ì •', icon: 'âš™ï¸' }
            ];

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'system':
                        return <SystemStatus />;
                    case 'projects':
                        return <ProjectManagement />;
                    case 'llm':
                        return <LLMManagement />;
                    case 'settings':
                        return <div className="settings">âš™ï¸ ì„¤ì • ê¸°ëŠ¥ ê°œë°œ ì¤‘...</div>;
                    default:
                        return <SystemStatus />;
                }
            };

            return (
                <div className="admin-dashboard">
                    <header className="admin-header">
                        <div className="header-left">
                            <h1>ğŸ›¡ï¸ AI Chat Interface ê´€ë¦¬ì</h1>
                            <span className="user-info">ê´€ë¦¬ì: {user.username}</span>
                        </div>
                        <div className="header-right">
                            <button className="logout-btn" onClick={onLogout}>
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                    </header>

                    <div className="admin-layout">
                        <nav className="admin-sidebar">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    className={`nav-tab ${activeTab === tab.id ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab.id)}
                                >
                                    <span className="tab-icon">{tab.icon}</span>
                                    <span className="tab-name">{tab.name}</span>
                                </button>
                            ))}
                        </nav>

                        <main className="admin-content">
                            {renderTabContent()}
                        </main>
                    </div>
                </div>
            );
        }

        // ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸
        function AdminApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // í† í° ê²€ì¦
                const verifyToken = async () => {
                    const token = getAuthToken();
                    if (!token) {
                        setLoading(false);
                        return;
                    }

                    try {
                        const response = await axios.get('/api/admin/verify', { headers: getAuthHeaders() });
                        if (response.data.success) {
                            setUser(response.data.admin);
                        }
                    } catch (error) {
                        removeAuthToken();
                    } finally {
                        setLoading(false);
                    }
                };

                verifyToken();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                removeAuthToken();
                setUser(null);
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading">ê´€ë¦¬ì ì‹œìŠ¤í…œ ë¡œë“œ ì¤‘...</div>
                    </div>
                );
            }

            return user ?
                <AdminDashboard user={user} onLogout={handleLogout} /> :
                <LoginForm onLogin={handleLogin} />;
        }

        // ë Œë”ë§
        ReactDOM.render(<AdminApp />, document.getElementById('admin-root'));
    </script>
</body>
</html>