<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent ê´€ë¦¬ - AI Chat Interface</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Agent ê´€ë¦¬</h1>
            <div class="project-info">
                <span id="projectIdDisplay">Project ID: </span>
                <span id="frameworkDisplay">Framework: </span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('agents')">Agents</button>
            <button class="tab" onclick="location.href='task_manager.html' + location.search">Tasks</button>
        </div>

        <div class="content-area">
            <div class="requirement-box" id="requirementBox" style="display:none;">
                <h3 class="requirement-title">ğŸ“Œ í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­</h3>
                <p class="requirement-text" id="requirementText"></p>
            </div>
            <div class="section-header">
                <h2>Agent ëª©ë¡</h2>
                <button class="add-btn" onclick="openAddAgentModal()">+ Agent ì¶”ê°€</button>
            </div>

            <div class="agents-grid" id="agentsGrid">
                <!-- Agent ì¹´ë“œê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="execute-section">
                <h3 style="margin-bottom: 15px;">ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰</h3>
                <button class="execute-btn" onclick="generateAndExecute()">
                    ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Agent ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="agentModal">
        <div class="modal-content">
            <h2 id="modalTitle">Agent ì¶”ê°€</h2>
            <form id="agentForm">
                <div class="form-group">
                    <label>Agent Order *</label>
                    <input type="number" id="agentOrder" required min="1">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <input type="text" id="agentRole" required>
                </div>
                <div class="form-group">
                    <label>Goal *</label>
                    <textarea id="agentGoal" required></textarea>
                </div>
                <div class="form-group">
                    <label>Backstory *</label>
                    <textarea id="agentBackstory" required></textarea>
                </div>
                <div class="form-group">
                    <label>LLM Model</label>
                    <select id="agentLlm">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agentVerbose" checked>
                        Verbose
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agentDelegation">
                        Allow Delegation
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAgentModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var projectId = '';
        var framework = '';
        var agents = [];
        var editingAgentOrder = null;
        var sharedRequirement = '';

        function extractRequirementFromGoal(goal) {
            if (!goal) return '';
            const idx = goal.indexOf(':');
            if (idx === -1) return '';
            return goal.slice(idx + 1).trim();
        }

        function splitGoal(goal) {
            if (!goal) {
                return { summary: '', detail: '' };
            }
            const idx = goal.indexOf(':');
            if (idx === -1) {
                return { summary: goal.trim(), detail: '' };
            }
            return {
                summary: goal.slice(0, idx).trim(),
                detail: goal.slice(idx + 1).trim()
            };
        }

        function splitBackstory(backstory) {
            if (!backstory) {
                return { lead: '', detail: '' };
            }
            const trimmed = backstory.trim();
            const idx = trimmed.indexOf('.');
            if (idx === -1) {
                return { lead: trimmed, detail: '' };
            }
            return {
                lead: trimmed.slice(0, idx + 1).trim(),
                detail: trimmed.slice(idx + 1).trim()
            };
        }

        function updateRequirementBox() {
            const box = document.getElementById('requirementBox');
            const textEl = document.getElementById('requirementText');
            if (!box || !textEl) return;
            if (sharedRequirement) {
                box.style.display = 'block';
                textEl.innerHTML = sharedRequirement.replace(/\n/g, '<br>');
            } else {
                box.style.display = 'none';
                textEl.innerHTML = '';
            }
        }
        // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
        var urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('project_id');
        framework = urlParams.get('framework') || 'crewai';

        // sessionStorageì—ì„œ ì „ë‹¬ëœ ê°’ ë³µì›
        (function restoreFromSession() {
            const stored = sessionStorage.getItem('agent_manager_params');
            if (!stored) return;
            try {
                const parsed = JSON.parse(stored);
                if (!projectId && parsed.project_id) {
                    projectId = parsed.project_id;
                }
                if (parsed.framework) {
                    framework = parsed.framework;
                }
                if (parsed.requirement) {
                    sharedRequirement = parsed.requirement;
                    updateRequirementBox();
                }
            } catch (error) {
                console.warn('Failed to parse agent_manager_params:', error);
            } finally {
                try {
                    sessionStorage.removeItem('agent_manager_params');
                } catch (e) {
                    console.warn('sessionStorage remove failed:', e);
                }
            }
        })();

        // í˜ì´ì§€ ë¡œë“œ
        async function initializeAgentManager() {
            if (!projectId) {
                alert('í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/pre_analysis.html';
                return;
            }

            document.getElementById('projectIdDisplay').textContent = `Project ID: ${projectId}`;
            document.getElementById('frameworkDisplay').textContent = `Framework: ${framework}`;
            updateRequirementBox();

            await loadAgents();
        }

        initializeAgentManager();

        // Agent ëª©ë¡ ë¡œë“œ
        async function loadAgents() {
            try {
                const response = await fetch(`/api/v2/projects/${projectId}/agents?framework=${framework}`);
                const data = await response.json();
                agents = data.agents || [];
                sharedRequirement = "";
                for (const agent of agents) {
                    const requirementText = extractRequirementFromGoal(agent.goal);
                    if (requirementText) {
                        sharedRequirement = requirementText;
                        break;
                    }
                }
                sharedRequirement = sharedRequirement ? sharedRequirement.trim() : '';
                updateRequirementBox();
                renderAgents();
            } catch (error) {
                console.error('Error loading agents:', error);
            }
        }

        // Agent ë Œë”ë§
        function renderAgents() {
            const grid = document.getElementById('agentsGrid');
            grid.innerHTML = '';

            if (!agents.length) {
                grid.innerHTML = '<p class="empty-placeholder">ë“±ë¡ëœ Agentê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            agents.forEach(agent => {
                const card = document.createElement('div');
                card.className = 'agent-card';
                const goalInfo = splitGoal(agent.goal);
                const backstoryInfo = splitBackstory(agent.backstory);
                const requirementDetail = (goalInfo.detail && sharedRequirement && goalInfo.detail.trim() === sharedRequirement.trim()) ? '' : goalInfo.detail;
                const verboseLabel = agent.is_verbose ? 'Verbose' : 'Concise';
                const verboseClass = agent.is_verbose ? 'flag-verbose' : 'flag-quiet';
                const delegationFlag = agent.allow_delegation ? '<span class="flag flag-delegation">Delegation</span>' : '';
                card.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-order">${agent.agent_order ?? '-'}</div>
                        <div class="agent-role">
                            <h3>${agent.role || '-'}</h3>
                            <span class="agent-llm">${agent.llm_model || '-'}</span>
                            <div class="agent-flags">
                                <span class="flag ${verboseClass}">${verboseLabel}</span>
                                ${delegationFlag}
                            </div>
                        </div>
                    </div>
                    <div class="agent-details">
                        <div class="agent-detail">
                            <label>Goal</label>
                            <p class="goal-summary">${goalInfo.summary || '-'}</p>
                            ${requirementDetail ? `<p class="goal-detail">${requirementDetail}</p>` : ''}
                        </div>
                        <div class="agent-detail">
                            <label>Backstory</label>
                            <p class="backstory-lead">${backstoryInfo.lead || '-'}</p>
                            ${backstoryInfo.detail ? `<p class="backstory-detail">${backstoryInfo.detail}</p>` : ''}
                        </div>
                    </div>
                    <div class="agent-actions">
                        <button class="action-btn edit" onclick="editAgent(${agent.agent_order})">ìˆ˜ì •</button>
                        <button class="action-btn delete" onclick="deleteAgent(${agent.agent_order})">ì‚­ì œ</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Agent ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        function openAddAgentModal() {
            editingAgentOrder = null;
            document.getElementById('modalTitle').textContent = 'Agent ì¶”ê°€';
            document.getElementById('agentForm').reset();
            document.getElementById('agentModal').classList.add('show');
        }

        // Agent ìˆ˜ì •
        function editAgent(agentOrder) {
            const agent = agents.find(a => a.agent_order === agentOrder);
            if (!agent) return;

            editingAgentOrder = agentOrder;
            document.getElementById('modalTitle').textContent = 'Agent ìˆ˜ì •';
            document.getElementById('agentOrder').value = agent.agent_order;
            document.getElementById('agentRole').value = agent.role;
            document.getElementById('agentGoal').value = agent.goal;
            document.getElementById('agentBackstory').value = agent.backstory;
            document.getElementById('agentLlm').value = agent.llm_model;
            document.getElementById('agentVerbose').checked = agent.is_verbose;
            document.getElementById('agentDelegation').checked = agent.allow_delegation;

            document.getElementById('agentModal').classList.add('show');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('show');
        }

        // Agent ì €ì¥
        document.getElementById('agentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const agentData = {
                framework: framework,
                agentOrder: parseInt(document.getElementById('agentOrder').value),
                role: document.getElementById('agentRole').value,
                goal: document.getElementById('agentGoal').value,
                backstory: document.getElementById('agentBackstory').value,
                llmModel: document.getElementById('agentLlm').value,
                isVerbose: document.getElementById('agentVerbose').checked,
                allowDelegation: document.getElementById('agentDelegation').checked
            };

            try {
                let url, method;
                if (editingAgentOrder !== null) {
                    // ìˆ˜ì •
                    url = `/api/v2/projects/${projectId}/agents/${editingAgentOrder}`;
                    method = 'PUT';
                } else {
                    // ì¶”ê°€
                    url = `/api/v2/projects/${projectId}/agents`;
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(agentData)
                });

                if (response.ok) {
                    closeAgentModal();
                    await loadAgents();
                } else {
                    alert('Agent ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error saving agent:', error);
                alert('Agent ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Agent ì‚­ì œ
        async function deleteAgent(agentOrder) {
            if (!confirm('ì •ë§ ì´ Agentë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/v2/projects/${projectId}/agents/${agentOrder}?framework=${framework}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadAgents();
                } else {
                    alert('Agent ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error deleting agent:', error);
                alert('Agent ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
        async function generateAndExecute() {
            if (!confirm('ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                // ë™ì  ìŠ¤í¬ë¦½íŠ¸ ìƒì„± API í˜¸ì¶œ
                const response = await fetch('/api/generate-script', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        projectId: projectId,
                        framework: framework
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`âœ… ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ!\nê²½ë¡œ: ${data.script_path}\n\nì‹¤í–‰ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
                    // ì‹¤í–‰ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = `/?tab=crewai&project_id=${projectId}`;
                } else {
                    alert('ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showTab(tab) {
            // íƒ­ ì „í™˜ ë¡œì§ (í•„ìš”ì‹œ êµ¬í˜„)
        }
    </script>
</body>
</html>
