const { useState, useEffect, useRef, createElement: e } = React;

const AIChatInterface = () => {
    const [selectedAI, setSelectedAI] = useState('crew-ai');
    const [selectedRole, setSelectedRole] = useState('');
    const [roleLLMMapping, setRoleLLMMapping] = useState({});
    const [messages, setMessages] = useState([]);
    const [inputText, setInputText] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [showProjects, setShowProjects] = useState(false);

    const aiOptions = [
        {
            id: 'crew-ai',
            name: 'CREW AI',
            description: 'ÌòëÏóÖ Í∏∞Î∞ò AI ÏóêÏù¥Ï†ÑÌä∏',
            roles: [
                { id: 'researcher', name: 'Researcher', description: 'Ï†ïÎ≥¥ ÏàòÏßë Î∞è Î∂ÑÏÑù' },
                { id: 'writer', name: 'Writer', description: 'ÏΩòÌÖêÏ∏† ÏÉùÏÑ± Î∞è Î¨∏ÏÑúÌôî' },
                { id: 'planner', name: 'Planner', description: 'Ï†ÑÎûµ ÏàòÎ¶Ω Î∞è Í≥ÑÌöç' }
            ]
        },
        {
            id: 'meta-gpt',
            name: 'MetaGPT',
            description: 'Îã®Í≥ÑÎ≥Ñ ÏäπÏù∏ Í∏∞Î∞ò Ï†ÑÎ¨∏ Í∞úÎ∞úÌåÄ',
            roles: [
                { id: 'product-manager', name: 'Product Manager', description: 'ÏöîÍµ¨ÏÇ¨Ìï≠ Ï†ïÎ¶¨ Î∞è PRD ÏûëÏÑ±' },
                { id: 'architect', name: 'Architect', description: 'ÏãúÏä§ÌÖú ÏÑ§Í≥Ñ Î∞è Íµ¨Ï°∞ Í≥ÑÌöç' },
                { id: 'project-manager', name: 'Project Manager', description: 'ÏûëÏóÖ Î∂ÑÏÑù Î∞è Í≥ÑÌöç ÏàòÎ¶Ω' },
                { id: 'engineer', name: 'Engineer', description: 'ÏΩîÎìú Í∞úÎ∞ú Î∞è Íµ¨ÌòÑ' },
                { id: 'qa-engineer', name: 'QA Engineer', description: 'ÌÖåÏä§Ìä∏ Î∞è ÌíàÏßà Î≥¥Ï¶ù' }
            ]
        }
    ];

    // LLM Î™®Îç∏ Î™©Î°ù (ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê®)
    let llmOptions = [];

    // LLM Î™®Îç∏ ÎèôÏ†Å Î°úÎìú
    const loadLLMModels = async () => {
        try {
            const response = await fetch('/api/llm/models');
            const data = await response.json();

            if (data.success) {
                llmOptions = data.models.map(model => ({
                    id: model.id,
                    name: model.name,
                    description: model.description || '',
                    provider: model.provider,
                    type: model.type || 'cloud',
                    parameter_size: model.parameter_size
                }));
                console.log('LLM Î™®Îç∏ Î°úÎìú ÏôÑÎ£å:', llmOptions.length, 'Í∞ú');
            } else {
                console.error('LLM Î™®Îç∏ Î°úÎìú Ïã§Ìå®:', data.error);
                // Í∏∞Î≥∏ Î™®Îç∏ ÏÑ§Ï†ï
                llmOptions = [
                    { id: 'gpt-4', name: 'GPT-4', description: 'Î≤îÏö© Í≥†ÏÑ±Îä• Î™®Îç∏', provider: 'OpenAI', type: 'cloud' },
                    { id: 'claude-3', name: 'Claude-3 Sonnet', description: 'Ï∂îÎ°† ÌäπÌôî Î™®Îç∏', provider: 'Anthropic', type: 'cloud' }
                ];
            }
        } catch (error) {
            console.error('LLM Î™®Îç∏ Î°úÎìú Ïò§Î•ò:', error);
            // Í∏∞Î≥∏ Î™®Îç∏ ÏÑ§Ï†ï
            llmOptions = [
                { id: 'gpt-4', name: 'GPT-4', description: 'Î≤îÏö© Í≥†ÏÑ±Îä• Î™®Îç∏', provider: 'OpenAI', type: 'cloud' },
                { id: 'claude-3', name: 'Claude-3 Sonnet', description: 'Ï∂îÎ°† ÌäπÌôî Î™®Îç∏', provider: 'Anthropic', type: 'cloud' }
            ];
        }
    };

    // AI Î≥ÄÍ≤Ω Ïãú Ï≤´ Î≤àÏß∏ Ïó≠Ìï† ÏûêÎèô ÏÑ†ÌÉù
    useEffect(() => {
        const initializeInterface = async () => {
            await loadLLMModels();

            const selectedAIData = aiOptions.find(ai => ai.id === selectedAI);
            if (selectedAIData && selectedAIData.roles.length > 0) {
                setSelectedRole(selectedAIData.roles[0].id);
            }
        };

        initializeInterface();
    }, [selectedAI]);

    // Î©îÏãúÏßÄ Ï†ÑÏÜ°
    const sendMessage = async () => {
        if (!inputText.trim() || !selectedRole) return;

        const userMessage = {
            id: Date.now(),
            type: 'user',
            content: inputText,
            ai: selectedAI,
            role: selectedRole,
            timestamp: new Date().toISOString()
        };

        setMessages(prev => [...prev, userMessage]);
        setInputText('');
        setIsLoading(true);

        try {
            const endpoint = selectedAI === 'crew-ai' ? '/api/crewai' : '/api/metagpt';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: inputText,
                    role: selectedRole,
                    llm_model: roleLLMMapping[selectedRole] || 'gpt-4'
                })
            });

            const data = await response.json();

            const aiMessage = {
                id: Date.now() + 1,
                type: 'ai',
                content: data.response || 'ÏùëÎãµÏùÑ Î∞õÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.',
                ai: selectedAI,
                role: selectedRole,
                timestamp: new Date().toISOString()
            };

            setMessages(prev => [...prev, aiMessage]);
        } catch (error) {
            console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
            const errorMessage = {
                id: Date.now() + 1,
                type: 'error',
                content: 'Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
                timestamp: new Date().toISOString()
            };
            setMessages(prev => [...prev, errorMessage]);
        } finally {
            setIsLoading(false);
        }
    };

    // LLM Îß§Ìïë Î≥ÄÍ≤Ω
    const handleLLMChange = (roleId, llmId) => {
        setRoleLLMMapping(prev => ({
            ...prev,
            [roleId]: llmId
        }));
    };

    // ÏóîÌÑ∞ ÌÇ§ Ï≤òÎ¶¨
    const handleKeyPress = (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    };

    // ÎåÄÏãúÎ≥¥ÎìúÎ°ú Ïù¥Îèô
    const goToDashboard = () => {
        window.location.href = '/dashboard.html';
    };

    const currentAI = aiOptions.find(ai => ai.id === selectedAI);
    const currentRole = currentAI?.roles.find(role => role.id === selectedRole);

    return e('div', { className: 'ai-chat-container' },
        // Header
        e('header', { className: 'chat-header' },
            e('div', { className: 'header-left' },
                e('button', {
                    className: 'dashboard-btn',
                    onClick: goToDashboard
                }, 'üè† ÎåÄÏãúÎ≥¥Îìú'),
                e('h1', null, 'ü§ñ AI ÌîÑÎ°úÍ∑∏Îû® ÏÉùÏÑ± ÎåÄÌôîÏ∞Ω')
            ),
            e('div', { className: 'header-right' },
                e('button', {
                    className: 'projects-btn',
                    onClick: () => setShowProjects(!showProjects)
                }, 'üìÅ ÌîÑÎ°úÏ†ùÌä∏')
            )
        ),

        // Main Content
        e('div', { className: 'chat-main' },
            // Left Sidebar
            e('aside', { className: 'chat-sidebar' },
                // AI ÏÑ†ÌÉù
                e('section', { className: 'ai-selection' },
                    e('h3', null, 'üéØ AI ÌîÑÎ†àÏûÑÏõåÌÅ¨'),
                    e('div', { className: 'ai-options' },
                        ...aiOptions.map(ai =>
                            e('div', {
                                key: ai.id,
                                className: `ai-option ${selectedAI === ai.id ? 'selected' : ''}`,
                                onClick: () => setSelectedAI(ai.id)
                            },
                                e('h4', null, ai.name),
                                e('p', null, ai.description),
                                e('span', { className: 'role-count' }, `${ai.roles.length}Í∞ú Ïó≠Ìï†`)
                            )
                        )
                    )
                ),

                // Ïó≠Ìï† ÏÑ†ÌÉù
                currentAI && e('section', { className: 'role-selection' },
                    e('h3', null, 'üë• Ïó≠Ìï† ÏÑ†ÌÉù'),
                    e('div', { className: 'role-options' },
                        ...currentAI.roles.map(role =>
                            e('div', {
                                key: role.id,
                                className: `role-option ${selectedRole === role.id ? 'selected' : ''}`,
                                onClick: () => setSelectedRole(role.id)
                            },
                                e('h4', null, role.name),
                                e('p', null, role.description)
                            )
                        )
                    )
                ),

                // LLM Î™®Îç∏ ÏÑ§Ï†ï
                currentAI && e('section', { className: 'llm-mapping' },
                    e('h3', null, 'üß† LLM Î™®Îç∏ ÏÑ§Ï†ï'),
                    ...currentAI.roles.map(role =>
                        e('div', {
                            key: role.id,
                            className: 'llm-option'
                        },
                            e('label', null, role.name),
                            e('select', {
                                value: roleLLMMapping[role.id] || 'gpt-4',
                                onChange: (ev) => handleLLMChange(role.id, ev.target.value)
                            },
                                ...llmOptions.map(llm =>
                                    e('option', {
                                        key: llm.id,
                                        value: llm.id
                                    }, `${llm.type === 'local' ? 'üè†' : '‚òÅÔ∏è'} ${llm.name} (${llm.provider})${llm.parameter_size ? ` [${llm.parameter_size}]` : ''}`)
                                )
                            )
                        )
                    )
                )
            ),

            // Chat Area
            e('div', { className: 'chat-area' },
                e('div', { className: 'chat-info' },
                    currentRole && e('div', { className: 'current-selection' },
                        e('span', { className: 'current-ai' }, currentAI.name),
                        e('span', { className: 'separator' }, '‚Ä¢'),
                        e('span', { className: 'current-role' }, currentRole.name),
                        e('span', { className: 'separator' }, '‚Ä¢'),
                        e('span', { className: 'current-llm' },
                            (() => {
                                const llm = llmOptions.find(l => l.id === (roleLLMMapping[selectedRole] || 'gpt-4'));
                                return llm ? `${llm.type === 'local' ? 'üè†' : '‚òÅÔ∏è'} ${llm.name}` : 'Unknown';
                            })()
                        )
                    )
                ),

                e('div', { className: 'messages-container' },
                    messages.length === 0 ?
                        e('div', { className: 'welcome-message' },
                            e('h2', null, 'üöÄ AI ÌîÑÎ°úÍ∑∏Îû® ÏÉùÏÑ±ÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî!'),
                            e('p', null, 'Ï¢åÏ∏°ÏóêÏÑú AI ÌîÑÎ†àÏûÑÏõåÌÅ¨ÏôÄ Ïó≠Ìï†ÏùÑ ÏÑ†ÌÉùÌïú ÌõÑ ÎåÄÌôîÎ•º ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.'),
                            e('div', { className: 'features' },
                                e('div', { className: 'feature' },
                                    e('h4', null, 'ü§ù CREW AI'),
                                    e('p', null, '3Í∞ú Ïó≠Ìï†Ïù¥ ÌòëÏóÖÌïòÏó¨ ÏûëÏóÖÏùÑ ÏàòÌñâÌï©ÎãàÎã§.')
                                ),
                                e('div', { className: 'feature' },
                                    e('h4', null, 'üèóÔ∏è MetaGPT'),
                                    e('p', null, '5Îã®Í≥Ñ ÏäπÏù∏ ÌîÑÎ°úÏÑ∏Ïä§Î°ú Ï≤¥Í≥ÑÏ†ÅÏúºÎ°ú Í∞úÎ∞úÌï©ÎãàÎã§.')
                                )
                            )
                        ) :
                        messages.map(message =>
                            e('div', {
                                key: message.id,
                                className: `message ${message.type}`
                            },
                                e('div', { className: 'message-header' },
                                    e('span', { className: 'message-info' },
                                        `${message.type === 'user' ? 'üë§ ÏÇ¨Ïö©Ïûê' : 'ü§ñ ' + aiOptions.find(ai => ai.id === message.ai)?.name} - ${message.role}`
                                    ),
                                    e('span', { className: 'message-time' },
                                        new Date(message.timestamp).toLocaleTimeString()
                                    )
                                ),
                                e('div', { className: 'message-content' }, message.content)
                            )
                        )
                ),

                e('div', { className: 'input-container' },
                    e('textarea', {
                        value: inputText,
                        onChange: (ev) => setInputText(ev.target.value),
                        onKeyPress: handleKeyPress,
                        placeholder: currentRole ? `${currentRole.name}ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ÏÑ∏Ïöî...` : 'Ïó≠Ìï†ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî',
                        rows: 3,
                        disabled: isLoading || !selectedRole
                    }),
                    e('button', {
                        onClick: sendMessage,
                        disabled: isLoading || !inputText.trim() || !selectedRole,
                        className: 'send-button'
                    }, isLoading ? '‚è≥ Ï†ÑÏÜ° Ï§ë...' : 'üì§ Ï†ÑÏÜ°')
                )
            )
        )
    );
};

// React 18 createRoot API ÏÇ¨Ïö©
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(e(AIChatInterface));