<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrewAI Enhanced Logging Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        input[type="text"], select, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.3em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #555;
        }

        .summary-value {
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }

        .logs-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logs-title {
            font-size: 1.4em;
            color: #333;
            font-weight: 700;
        }

        .logs-counter {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .logs-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            background: #fafafa;
        }

        .log-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            background: #f0f8ff;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9em;
        }

        .log-timestamp {
            color: #666;
            font-weight: 500;
        }

        .log-phase {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8em;
        }

        .log-level {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8em;
            color: white;
        }

        .log-level.INFO {
            background: #4caf50;
        }

        .log-level.WARNING {
            background: #ff9800;
        }

        .log-level.ERROR {
            background: #f44336;
        }

        .log-level.DEBUG {
            background: #9e9e9e;
        }

        .log-message {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .log-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
        }

        .phase-progress {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .phase-step {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .phase-step.completed {
            background: #4caf50;
            color: white;
        }

        .phase-step.active {
            background: #2196f3;
            color: white;
        }

        .phase-step.pending {
            background: #e0e0e0;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .no-logs {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
            font-size: 1.1em;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç CrewAI Enhanced Logging Dashboard</h1>
            <p>Ïã§ÏãúÍ∞Ñ CrewAI ÌîÑÎ°úÍ∑∏Îû® ÏÉùÏÑ± Î∞è Ïã§Ìñâ Î°úÍ∑∏ Î™®ÎãàÌÑ∞ÎßÅ</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="executionId">Execution ID:</label>
                <input type="text" id="executionId" placeholder="execution-id-Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            </div>
            <div class="control-group">
                <button onclick="loadLogs()">Î°úÍ∑∏ Ï°∞Ìöå</button>
                <button onclick="clearLogs()">Î°úÍ∑∏ ÏßÄÏö∞Í∏∞</button>
            </div>
            <div class="control-group auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏</label>
            </div>
            <div class="control-group connection-status">
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">Ïó∞Í≤∞ Ï§ë...</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h3>üìä Ïã§Ìñâ ÏöîÏïΩ</h3>
                <div id="summaryContent">
                    <div class="no-logs">Execution IDÎ•º ÏûÖÎ†•ÌïòÍ≥† Î°úÍ∑∏Î•º Ï°∞ÌöåÌïòÏÑ∏Ïöî.</div>
                </div>
            </div>

            <div class="panel">
                <h3>‚è±Ô∏è Îã®Í≥ÑÎ≥Ñ ÏßÑÌñâÏÉÅÌô©</h3>
                <div id="phaseProgress">
                    <div class="phase-progress">
                        <div class="phase-step pending">Ï¥àÍ∏∞Ìôî</div>
                        <div class="phase-step pending">Ï§ÄÎπÑ</div>
                        <div class="phase-step pending">üìã Planner</div>
                        <div class="phase-step pending">üîç Researcher</div>
                        <div class="phase-step pending">‚úçÔ∏è Writer</div>
                        <div class="phase-step pending">ÏôÑÎ£å</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="logs-container">
            <div class="logs-header">
                <div class="logs-title">üìù Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏</div>
                <div class="logs-counter" id="logsCounter">Î°úÍ∑∏ 0Í∞ú</div>
            </div>

            <div class="log-filters">
                <button class="filter-btn active" data-level="ALL">Ï†ÑÏ≤¥</button>
                <button class="filter-btn" data-level="INFO">Ï†ïÎ≥¥</button>
                <button class="filter-btn" data-level="WARNING">Í≤ΩÍ≥†</button>
                <button class="filter-btn" data-level="ERROR">Ïò§Î•ò</button>
                <button class="filter-btn" data-level="DEBUG">ÎîîÎ≤ÑÍ∑∏</button>
            </div>

            <div class="logs-list" id="logsList">
                <div class="no-logs">Ïã§Ìñâ Î°úÍ∑∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentExecutionId = null;
        let logs = [];
        let currentFilter = 'ALL';
        let autoRefreshInterval = null;

        // ÏÜåÏºì Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî
        function initSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('üîó WebSocket Ïó∞Í≤∞Îê®');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('üîå WebSocket Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
            });

            socket.on('log_update', function(data) {
                console.log('üìù ÏÉà Î°úÍ∑∏ ÏàòÏã†:', data);
                if (data.execution_id === currentExecutionId) {
                    addLogEntry(data);
                }
            });

            socket.on('joined_room', function(data) {
                console.log('üè† Î£∏ Ï∞∏Ïó¨:', data);
            });

            socket.on('error', function(error) {
                console.error('‚ùå WebSocket Ïò§Î•ò:', error);
            });
        }

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');

            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'Ïó∞Í≤∞Îê®';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'Ïó∞Í≤∞ Ìï¥Ï†úÎê®';
            }
        }

        // Î°úÍ∑∏ Ï°∞Ìöå
        async function loadLogs() {
            const executionId = document.getElementById('executionId').value.trim();
            if (!executionId) {
                alert('Execution IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            currentExecutionId = executionId;
            showLoading();

            try {
                // Í∏∞Ï°¥ Î£∏ÏóêÏÑú ÎÇòÍ∞ÄÍ∏∞
                if (socket && currentExecutionId) {
                    socket.emit('leave_execution_room', { execution_id: currentExecutionId });
                }

                // ÏÉà Î£∏ Ï∞∏Ïó¨
                if (socket) {
                    socket.emit('join_execution_room', { execution_id: executionId });
                }

                // Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                const response = await fetch(`/api/crewai/logs/${executionId}`);
                const data = await response.json();

                if (data.success) {
                    logs = data.logs || [];
                    updateSummary(data.summary);
                    updatePhaseProgress(data.summary);
                    displayLogs();
                } else {
                    showError(data.error || 'Î°úÍ∑∏ Ï°∞Ìöå Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Î°úÍ∑∏ Ï°∞Ìöå Ïò§Î•ò:', error);
                showError('Î°úÍ∑∏ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateSummary(summary) {
            const summaryContent = document.getElementById('summaryContent');

            if (!summary || Object.keys(summary).length === 0) {
                summaryContent.innerHTML = '<div class="no-logs">ÏöîÏïΩ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            summaryContent.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">Ïã§Ìñâ ID</span>
                    <span class="summary-value">${summary.execution_id || 'N/A'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ï¥ù Î°úÍ∑∏ Ïàò</span>
                    <span class="summary-value">${summary.total_logs || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ÏãúÏûë ÏãúÍ∞Ñ</span>
                    <span class="summary-value">${formatTime(summary.start_time)}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ï¢ÖÎ£å ÏãúÍ∞Ñ</span>
                    <span class="summary-value">${formatTime(summary.end_time)}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ïò§Î•ò Î∞úÏÉù</span>
                    <span class="summary-value" style="color: ${summary.has_errors ? '#f44336' : '#4caf50'}">
                        ${summary.has_errors ? 'ÏûàÏùå' : 'ÏóÜÏùå'}
                    </span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Í≤ΩÍ≥† Î∞úÏÉù</span>
                    <span class="summary-value" style="color: ${summary.has_warnings ? '#ff9800' : '#4caf50'}">
                        ${summary.has_warnings ? 'ÏûàÏùå' : 'ÏóÜÏùå'}
                    </span>
                </div>
            `;
        }

        // CrewAI ÏõåÌÅ¨ÌîåÎ°úÏö∞ Îã®Í≥ÑÎ≥Ñ ÏßÑÌñâÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏ (Planner ‚Üí Researcher ‚Üí Writer)
        function updatePhaseProgress(summary) {
            const phaseSteps = document.querySelectorAll('.phase-step');
            const phases = ['initialization', 'preparation', 'planner', 'researcher', 'writer', 'completion'];
            const crewaiRoles = ['Planner', 'Researcher', 'Writer'];

            // Î™®Îì† Îã®Í≥ÑÎ•º pendingÏúºÎ°ú Ï¥àÍ∏∞Ìôî
            phaseSteps.forEach(step => {
                step.className = 'phase-step pending';
            });

            if (summary && summary.phases) {
                // ÏùºÎ∞ò Îã®Í≥Ñ Ï≤òÎ¶¨
                phases.forEach((phase, index) => {
                    if (summary.phases[phase]) {
                        const phaseData = summary.phases[phase];
                        if (phaseData.errors > 0) {
                            phaseSteps[index].className = 'phase-step error';
                            phaseSteps[index].style.background = '#f44336';
                        } else if (phaseData.count > 0) {
                            phaseSteps[index].className = 'phase-step completed';
                        }
                    }
                });

                // CrewAI Ïó≠Ìï†Î≥Ñ ÏßÑÌñâ ÏÉÅÌô© Ï≤òÎ¶¨
                logs.forEach(log => {
                    if (log.details && log.details.role) {
                        const role = log.details.role;
                        const roleIndex = crewaiRoles.indexOf(role);
                        if (roleIndex >= 0) {
                            const stepIndex = roleIndex + 2; // PlannerÎäî index 2Î∂ÄÌÑ∞ ÏãúÏûë
                            if (log.details.status === 'ÏôÑÎ£å' || log.details.status === 'completed') {
                                phaseSteps[stepIndex].className = 'phase-step completed';
                            } else if (log.details.status === 'Ïã§ÌñâÏ§ë' || log.details.status === 'running') {
                                phaseSteps[stepIndex].className = 'phase-step active';
                            }
                        }
                    }
                });
            }
        }

        // Î°úÍ∑∏ ÌëúÏãú
        function displayLogs() {
            const logsList = document.getElementById('logsList');
            const logsCounter = document.getElementById('logsCounter');

            const filteredLogs = logs.filter(log =>
                currentFilter === 'ALL' || log.level === currentFilter
            );

            logsCounter.textContent = `Î°úÍ∑∏ ${filteredLogs.length}Í∞ú`;

            if (filteredLogs.length === 0) {
                logsList.innerHTML = '<div class="no-logs">ÌëúÏãúÌï† Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            const logsHtml = filteredLogs.map(log => createLogEntry(log)).join('');
            logsList.innerHTML = logsHtml;

            // ÏµúÏã† Î°úÍ∑∏Î°ú Ïä§ÌÅ¨Î°§
            logsList.scrollTop = logsList.scrollHeight;
        }

        // Î°úÍ∑∏ ÏóîÌä∏Î¶¨ ÏÉùÏÑ±
        function createLogEntry(log) {
            const details = log.details && Object.keys(log.details).length > 0
                ? `<div class="log-details">${JSON.stringify(log.details, null, 2)}</div>`
                : '';

            return `
                <div class="log-entry">
                    <div class="log-header">
                        <div class="log-meta">
                            <span class="log-timestamp">${formatTime(log.timestamp)}</span>
                            <span class="log-phase">${log.phase}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                        </div>
                    </div>
                    <div class="log-message">${log.message}</div>
                    ${details}
                </div>
            `;
        }

        // ÏÉà Î°úÍ∑∏ ÏóîÌä∏Î¶¨ Ï∂îÍ∞Ä
        function addLogEntry(logData) {
            logs.push(logData);
            displayLogs();
        }

        // Î°úÍ∑∏ ÏßÄÏö∞Í∏∞
        function clearLogs() {
            logs = [];
            displayLogs();
            document.getElementById('summaryContent').innerHTML = '<div class="no-logs">Î°úÍ∑∏Í∞Ä ÏßÄÏõåÏ°åÏäµÎãàÎã§.</div>';
        }

        // Î°úÎî© ÌëúÏãú
        function showLoading() {
            document.getElementById('logsList').innerHTML = '<div class="loading">Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
        }

        // Ïò§Î•ò ÌëúÏãú
        function showError(message) {
            document.getElementById('logsList').innerHTML = `<div class="no-logs">‚ùå ${message}</div>`;
        }

        // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString('ko-KR');
        }

        // ÌïÑÌÑ∞ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.level;
                displayLogs();
            });
        });

        // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                autoRefreshInterval = setInterval(() => {
                    if (currentExecutionId) {
                        loadLogs();
                    }
                }, 5000); // 5Ï¥àÎßàÎã§ ÏÉàÎ°úÍ≥†Ïπ®
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });

        // Enter ÌÇ§Î°ú Î°úÍ∑∏ Ï°∞Ìöå
        document.getElementById('executionId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadLogs();
            }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
        });
    </script>
</body>
</html>