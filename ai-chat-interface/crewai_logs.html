<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrewAI Enhanced Logging Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        input[type="text"], select, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.3em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #555;
        }

        .summary-value {
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }

        .logs-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logs-title {
            font-size: 1.4em;
            color: #333;
            font-weight: 700;
        }

        .logs-counter {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .logs-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            background: #fafafa;
        }

        .log-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            background: #f0f8ff;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9em;
        }

        .log-timestamp {
            color: #666;
            font-weight: 500;
        }

        .log-phase {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8em;
        }

        .log-level {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8em;
            color: white;
        }

        .log-level.INFO {
            background: #4caf50;
        }

        .log-level.WARNING {
            background: #ff9800;
        }

        .log-level.ERROR {
            background: #f44336;
        }

        .log-level.DEBUG {
            background: #9e9e9e;
        }

        .log-message {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .log-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
        }

        .phase-progress {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .phase-step {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .phase-step.completed {
            background: #4caf50;
            color: white;
        }

        .phase-step.active {
            background: #2196f3;
            color: white;
        }

        .phase-step.pending {
            background: #e0e0e0;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .no-logs {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
            font-size: 1.1em;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” CrewAI Enhanced Logging Dashboard</h1>
            <p>ì‹¤ì‹œê°„ CrewAI í”„ë¡œê·¸ë¨ ìƒì„± ë° ì‹¤í–‰ ë¡œê·¸ ëª¨ë‹ˆí„°ë§</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="executionId">Execution ID:</label>
                <input type="text" id="executionId" placeholder="execution-id-ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="control-group">
                <button onclick="loadLogs()">ë¡œê·¸ ì¡°íšŒ</button>
                <button onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
            <div class="control-group auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</label>
            </div>
            <div class="control-group connection-status">
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">ì—°ê²° ì¤‘...</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h3>ğŸ“Š ì‹¤í–‰ ìš”ì•½</h3>
                <div id="summaryContent">
                    <div class="no-logs">Execution IDë¥¼ ì…ë ¥í•˜ê³  ë¡œê·¸ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.</div>
                </div>
            </div>

            <div class="panel">
                <h3>â±ï¸ ë‹¨ê³„ë³„ ì§„í–‰ìƒí™©</h3>
                <div id="phaseProgress">
                    <div class="phase-progress">
                        <div class="phase-step pending">ì´ˆê¸°í™”</div>
                        <div class="phase-step pending">ì¤€ë¹„</div>
                        <div class="phase-step pending">ğŸ“‹ Planner</div>
                        <div class="phase-step pending">ğŸ” Researcher</div>
                        <div class="phase-step pending">âœï¸ Writer</div>
                        <div class="phase-step pending">ì™„ë£Œ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="logs-container">
            <div class="logs-header">
                <div class="logs-title">ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</div>
                <div class="logs-counter" id="logsCounter">ë¡œê·¸ 0ê°œ</div>
            </div>

            <div class="log-filters">
                <button class="filter-btn active" data-level="ALL">ì „ì²´</button>
                <button class="filter-btn" data-level="INFO">ì •ë³´</button>
                <button class="filter-btn" data-level="WARNING">ê²½ê³ </button>
                <button class="filter-btn" data-level="ERROR">ì˜¤ë¥˜</button>
                <button class="filter-btn" data-level="DEBUG">ë””ë²„ê·¸</button>
            </div>

            <div class="logs-list" id="logsList">
                <div class="no-logs">ì‹¤í–‰ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentExecutionId = null;
        let logs = [];
        let currentFilter = 'ALL';
        let autoRefreshInterval = null;

        // ì†Œì¼“ ì—°ê²° ì´ˆê¸°í™”
        function initSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('ğŸ”— WebSocket ì—°ê²°ë¨');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('ğŸ”Œ WebSocket ì—°ê²° í•´ì œë¨');
            });

            socket.on('log_update', function(data) {
                console.log('ğŸ“ ìƒˆ ë¡œê·¸ ìˆ˜ì‹ :', data);
                if (data.execution_id === currentExecutionId) {
                    addLogEntry(data);
                }
            });

            socket.on('joined_room', function(data) {
                console.log('ğŸ  ë£¸ ì°¸ì—¬:', data);
            });

            socket.on('error', function(error) {
                console.error('âŒ WebSocket ì˜¤ë¥˜:', error);
            });
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');

            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'ì—°ê²°ë¨';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'ì—°ê²° í•´ì œë¨';
            }
        }

        // ë¡œê·¸ ì¡°íšŒ
        async function loadLogs() {
            const executionId = document.getElementById('executionId').value.trim();
            if (!executionId) {
                alert('Execution IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            currentExecutionId = executionId;
            showLoading();

            try {
                // ê¸°ì¡´ ë£¸ì—ì„œ ë‚˜ê°€ê¸°
                if (socket && currentExecutionId) {
                    socket.emit('leave_execution_room', { execution_id: currentExecutionId });
                }

                // ìƒˆ ë£¸ ì°¸ì—¬
                if (socket) {
                    socket.emit('join_execution_room', { execution_id: executionId });
                }

                // ë¡œê·¸ ë°ì´í„° ì¡°íšŒ
                const response = await fetch(`/api/crewai/logs/${executionId}`);
                const data = await response.json();

                if (data.success) {
                    logs = data.logs || [];
                    updateSummary(data.summary);
                    updatePhaseProgress(data.summary);
                    displayLogs();
                } else {
                    showError(data.error || 'ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ë¡œê·¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showError('ë¡œê·¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSummary(summary) {
            const summaryContent = document.getElementById('summaryContent');

            if (!summary || Object.keys(summary).length === 0) {
                summaryContent.innerHTML = '<div class="no-logs">ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            summaryContent.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">ì‹¤í–‰ ID</span>
                    <span class="summary-value">${summary.execution_id || 'N/A'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì´ ë¡œê·¸ ìˆ˜</span>
                    <span class="summary-value">${summary.total_logs || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì‹œì‘ ì‹œê°„</span>
                    <span class="summary-value">${formatTime(summary.start_time)}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì¢…ë£Œ ì‹œê°„</span>
                    <span class="summary-value">${formatTime(summary.end_time)}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì˜¤ë¥˜ ë°œìƒ</span>
                    <span class="summary-value" style="color: ${summary.has_errors ? '#f44336' : '#4caf50'}">
                        ${summary.has_errors ? 'ìˆìŒ' : 'ì—†ìŒ'}
                    </span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ê²½ê³  ë°œìƒ</span>
                    <span class="summary-value" style="color: ${summary.has_warnings ? '#ff9800' : '#4caf50'}">
                        ${summary.has_warnings ? 'ìˆìŒ' : 'ì—†ìŒ'}
                    </span>
                </div>
            `;
        }

        // CrewAI ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ë³„ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ (Planner â†’ Researcher â†’ Writer)
        function updatePhaseProgress(summary) {
            const phaseSteps = document.querySelectorAll('.phase-step');
            const phases = ['initialization', 'preparation', 'planner', 'researcher', 'writer', 'completion'];
            const crewaiRoles = ['Planner', 'Researcher', 'Writer'];

            // ëª¨ë“  ë‹¨ê³„ë¥¼ pendingìœ¼ë¡œ ì´ˆê¸°í™”
            phaseSteps.forEach(step => {
                step.className = 'phase-step pending';
            });

            if (summary && summary.phases) {
                // ì¼ë°˜ ë‹¨ê³„ ì²˜ë¦¬
                phases.forEach((phase, index) => {
                    if (summary.phases[phase]) {
                        const phaseData = summary.phases[phase];
                        if (phaseData.errors > 0) {
                            phaseSteps[index].className = 'phase-step error';
                            phaseSteps[index].style.background = '#f44336';
                        } else if (phaseData.count > 0) {
                            phaseSteps[index].className = 'phase-step completed';
                        }
                    }
                });

                // CrewAI ì—­í• ë³„ ì§„í–‰ ìƒí™© ì²˜ë¦¬
                logs.forEach(log => {
                    if (log.details && log.details.role) {
                        const role = log.details.role;
                        const roleIndex = crewaiRoles.indexOf(role);
                        if (roleIndex >= 0) {
                            const stepIndex = roleIndex + 2; // PlannerëŠ” index 2ë¶€í„° ì‹œì‘
                            if (log.details.status === 'ì™„ë£Œ' || log.details.status === 'completed') {
                                phaseSteps[stepIndex].className = 'phase-step completed';
                            } else if (log.details.status === 'ì‹¤í–‰ì¤‘' || log.details.status === 'running') {
                                phaseSteps[stepIndex].className = 'phase-step active';
                            }
                        }
                    }
                });
            }
        }

        // ë¡œê·¸ í‘œì‹œ
        function displayLogs() {
            const logsList = document.getElementById('logsList');
            const logsCounter = document.getElementById('logsCounter');

            const filteredLogs = logs.filter(log =>
                currentFilter === 'ALL' || log.level === currentFilter
            );

            logsCounter.textContent = `ë¡œê·¸ ${filteredLogs.length}ê°œ`;

            if (filteredLogs.length === 0) {
                logsList.innerHTML = '<div class="no-logs">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const logsHtml = filteredLogs.map(log => createLogEntry(log)).join('');
            logsList.innerHTML = logsHtml;

            // ìµœì‹  ë¡œê·¸ë¡œ ìŠ¤í¬ë¡¤
            logsList.scrollTop = logsList.scrollHeight;
        }

        // ë¡œê·¸ ì—”íŠ¸ë¦¬ ìƒì„±
        function createLogEntry(log) {
            const details = log.details && Object.keys(log.details).length > 0
                ? `<div class="log-details">${JSON.stringify(log.details, null, 2)}</div>`
                : '';

            return `
                <div class="log-entry">
                    <div class="log-header">
                        <div class="log-meta">
                            <span class="log-timestamp">${formatTime(log.timestamp)}</span>
                            <span class="log-phase">${log.phase}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                        </div>
                    </div>
                    <div class="log-message">${log.message}</div>
                    ${details}
                </div>
            `;
        }

        // ìƒˆ ë¡œê·¸ ì—”íŠ¸ë¦¬ ì¶”ê°€
        function addLogEntry(logData) {
            logs.push(logData);
            displayLogs();
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLogs() {
            logs = [];
            displayLogs();
            document.getElementById('summaryContent').innerHTML = '<div class="no-logs">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            document.getElementById('logsList').innerHTML = '<div class="loading">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            document.getElementById('logsList').innerHTML = `<div class="no-logs">âŒ ${message}</div>`;
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString('ko-KR');
        }

        // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.level;
                displayLogs();
            });
        });

        // ìë™ ìƒˆë¡œê³ ì¹¨
        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                autoRefreshInterval = setInterval(() => {
                    if (currentExecutionId) {
                        loadLogs();
                    }
                }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });

        // Enter í‚¤ë¡œ ë¡œê·¸ ì¡°íšŒ
        document.getElementById('executionId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadLogs();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
        });
    </script>
</body>
</html>